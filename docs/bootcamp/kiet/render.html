<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificate Renderer</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&family=Montserrat:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&family=UnifrakturCook:wght@700&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            padding: 0;
            background: transparent;
        }
        #certificate-canvas {
            display: block;
        }
        #status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="status">Ready</div>
    <canvas id="certificate-canvas"></canvas>

    <!-- QRCode Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Certificate Renderer -->
    <script src="assets/js/certificate-renderer.js"></script>

    <script>
        // Status helper
        function setStatus(msg) {
            document.getElementById('status').textContent = msg;
            console.log('[Renderer]', msg);
        }

        // Wait for fonts to load (all weights used by the certificate renderer)
        // These are variable fonts â€” same woff2 covers all weights, but each
        // weight must be registered separately so the browser uses the real
        // weight axis instead of synthesizing faux-bold.
        async function waitForFonts() {
            setStatus('Loading fonts...');

            const fontsToLoad = [
                new FontFace('UnifrakturCook', 'url(https://fonts.gstatic.com/s/unifrakturcook/v25/IurA6Yli8YOdcoky-0PTTdkm56n05Xwy1oM.woff2)', { weight: '700' }),
                new FontFace('Cormorant Garamond', 'url(https://fonts.gstatic.com/s/cormorantgaramond/v21/co3bmX5slCNuHLi8bLeY9MK7whWMhyjYqXtK.woff2)', { weight: '400' }),
                new FontFace('Cormorant Garamond', 'url(https://fonts.gstatic.com/s/cormorantgaramond/v21/co3bmX5slCNuHLi8bLeY9MK7whWMhyjYqXtK.woff2)', { weight: '700' }),
                new FontFace('Cormorant Garamond', 'url(https://fonts.gstatic.com/s/cormorantgaramond/v21/co3smX5slCNuHLi8bLeY9MK7whWMhyjYrGFEsdtdc62E6zd58jD-iNM8.woff2)', { weight: '400', style: 'italic' }),
                new FontFace('Montserrat', 'url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459Wlhyw.woff2)', { weight: '400' }),
                new FontFace('Montserrat', 'url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459Wlhyw.woff2)', { weight: '600' }),
                new FontFace('Montserrat', 'url(https://fonts.gstatic.com/s/montserrat/v31/JTUSjIg1_i6t8kCHKm459Wlhyw.woff2)', { weight: '700' }),
                new FontFace('Outfit', 'url(https://fonts.gstatic.com/s/outfit/v15/QGYvz_MVcBeNP4NJtEtq.woff2)', { weight: '400' }),
                new FontFace('Outfit', 'url(https://fonts.gstatic.com/s/outfit/v15/QGYvz_MVcBeNP4NJtEtq.woff2)', { weight: '600' }),
                new FontFace('Outfit', 'url(https://fonts.gstatic.com/s/outfit/v15/QGYvz_MVcBeNP4NJtEtq.woff2)', { weight: '700' }),
            ];

            for (const font of fontsToLoad) {
                try {
                    await font.load();
                    document.fonts.add(font);
                } catch (e) {
                    console.warn('Font load warning:', font.family, e);
                }
            }

            await document.fonts.ready;
            setStatus('Fonts loaded');
        }

        // Main render function called by Playwright
        async function renderStudentCertificate(studentData, photoPath) {
            try {
                setStatus('Starting render for: ' + studentData.student_name);

                // Wait for fonts
                await waitForFonts();

                // Use photo path directly (should be base64 data URL from Python)
                let photoSrc = photoPath;

                // Render the certificate
                setStatus('Rendering certificate...');
                await renderCertificate(studentData, photoSrc, 'en');

                setStatus('Render complete');

                // Hide status for screenshot
                document.getElementById('status').style.display = 'none';

                // Return success (Playwright will take screenshot)
                const canvas = document.getElementById('certificate-canvas');
                return {
                    success: true,
                    width: canvas.width,
                    height: canvas.height
                };
            } catch (error) {
                setStatus('Error: ' + error.message);
                console.error(error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Export canvas as PNG data URL
        function getCanvasDataUrl(quality = 1.0) {
            const canvas = document.getElementById('certificate-canvas');
            return canvas.toDataURL('image/png', quality);
        }

        // Export canvas as JPEG data URL
        function getCanvasJpegDataUrl(quality = 0.95) {
            const canvas = document.getElementById('certificate-canvas');
            return canvas.toDataURL('image/jpeg', quality);
        }

        // Signal that the page is ready
        window.rendererReady = true;
        setStatus('Renderer ready');
    </script>
</body>
</html>
